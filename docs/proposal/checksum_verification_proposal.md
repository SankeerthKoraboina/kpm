# Technical Proposal for Checksum Verification in kpm

## Introduction

This proposal outlines a method for implementing checksum verification for dependencies in the `kpm` package manager to ensure integrity, consistency and authenticity.

### Purpose of checking checksum

A checksum, also known as a hash, is a sequence of letters and numbers that can be used to check data for errors. It can be generated by running a program that puts a file through an algorithm like `MD5`, `SHA-1` or `SHA-256/512`. Checksums can be used in package managers to identify modules, their descriptions and locations and the object attributes used in their views. They can also be used to verify the integrity of a package.

The purpose of checking checksum is to ensure that the downloaded package has not been tampered with or corrupted.

- **Integrity Verification**: Ensure that the files have not been tampered with since they were published.
- **Consistency**: Verify that the downloaded files are exactly the same as those originally published.
- **Authenticity**: Protect against malicious alterations.

## Research on Existing Tools

- **cargo**: Uses SHA256 checksums in `Cargo.lock`. During installation, Cargo verifies the checksum of each downloaded package against the `Cargo.lock` file.

- **npm**: Uses SHA512 checksums in `package-lock.json`. The `npm install` command verifies these checksums during the installation process.

- **go**: Uses checksums in `go.sum`.
  The `go get`and `go mod` commands verify these checksums during the build process.

References:

- https://doc.rust-lang.org/beta/nightly-rustc/cargo/sources/directory/struct.Checksum.html
- https://github.com/npm/cli/blob/04eb43f2b2a387987b61a7318908cf18f03d97e0/lib/utils/tar.js#L78-L80
- https://go.dev/ref/mod#go-sum-files

## Related to the Checksum Check Function

The checksum check function will be implemented in the `kpm` package manager by having some of common functions used to support it i.e. `checksumGeneration`, `checksumStorage` and `checksumVerification` along with the error handling strategies.

- **Checksum Generation**: It generates checksums for all dependencies files in the package when publishing.
- **Checksum Storage**: We may store the generated checksums in the `kcl.mod.lock` file.
- **Checksum Verification**: It is used to verify the checksums during package installation or update.

## Parts to Implement for Checksum Check

To implement checksum check, we need to finish the following:

**Checksum Generation**:

To support checksum generation we can use `SHA512` algorithm which is commonly used by other package manager and we need to modify the current publishing process in [modifile.go](pkg\package\modfile.go) to generate checksums for all files in a package.

The generated checksums can be stored in the `kcl.mod.lock` file.

**Checksum Storage**:

We can use the existing `kcl.mod.lock` file to store checksums. This can help us keep track of package integrity without introducing a new file or format, maintaining compatibility with existing workflows. We need to extend the `kcl.mod.lock` format to include a checksums section.

**Checksum Verification**:

During installation of dependencies, we need to read the checksums from the `kcl.mod.lock` file and need to verify the checksums of downloaded files against the stored checksums.

**Error Handling**:

For error handling we can implement clear and informative error messages for checksum mismatches.

## Functions in KPM to Add Checksum

To support the functionality of adding checksum, we need to extend the existing publish function to include checksum generation and save the generated checksums in the `kcl.mod.lock` file. We also need to modify the install function to verify checksums after downloading the files.

We can follow this initial changes to support the checksum verification of the dependencies in kpm.

We need to extend the Dependency struct to include a Checksums field and modify related functions to handle this new field.

The sum field does the same but we can rename it to the checksum for better align the field name for its functionality

```go
type Dependency struct {
    Name          string            `json:"name" toml:"name,omitempty"`
    FullName      string            `json:"-" toml:"full_name,omitempty"`
    Version       string            `json:"-" toml:"version,omitempty"`
    LocalFullPath string            `json:"manifest_path" toml:"-"`
    Checksum      string            `json:"checksum" toml:"checksum,omitempty"`
    downloader.Source `json:"-"`
}
```

Currently most of the code for `checksum verification` is done in `pkg/modfile.go`, `pkg/package.go` and at `client/client.go`. The current implementation for checksum is handled by `GenCheckSum` method and `GenOciManifestFromPkg` is generating an OCI manifest with name,version,desc, sum details. In `client.go` from `AcquireDepSum` method, we are fetching dependency from OCI and verifying the Checksum. This mostly setups the part of it and we have also maintaining metadata of dependencies in `kcl.mod.lock` including checksums.

To extend the checksum verification, I think we can include the checksum verification/validation steps in `LoadPkgFromPath`, `LoadModFile`, `LoadLockDeps` and `ResolvePkgDepsMetadata` functions which involves the loading of package info including fetching checksums from OCI, verifying them during the loading and updating of dependencies. Also we can extend it to `Updatedeps` function to verify checksums as part of update process to ensure any modifications to dependencies trigger reverification of checksums.

## Solution for Existing Dependencies Without Breaking Compatibility

For the existing dependencies that does not break compatibility we can use the `Incremental Rollout` method using the existing `FLAG_NO_SUM_CHECK` flag.

Initially, we can make checksum verification optional and generate log warnings for packages without checksums. Later after a transition period, we can make checksum verification mandatory for all the packages.

## Potential Improvements

The improvements we can think of adding storage for checksums maybe storing manifest in OCI registry and other improvements can be added after discussion with mentors for checksum verification of current implementation?
